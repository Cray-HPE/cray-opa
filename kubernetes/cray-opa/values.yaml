---
image:
  repository: artifactory.algol60.net/csm-docker/stable/docker.io/openpolicyagent/opa
  tag: 0.24.0-envoy-1  # When changing this, also update tests/opa//Dockerfile.
  pullPolicy: IfNotPresent

priorityClassName: csm-high-priority-service

ingresses:
  ingressgateway:
    # namespace of the ingress containers
    # this will likely be different than the OPA namespace
    namespace: istio-system
    labelSelector:
      istio: ingressgateway
    issuers:
      internal_http: "http://keycloak:8080/keycloak/realms/shasta"
      gw_http: "http://api-gw-service-nmn.local/keycloak/realms/shasta"
      gw_https: "https://api-gw-service-nmn.local/keycloak/realms/shasta"
  ingressgateway-customer-admin:
    namespace: istio-system
    labelSelector:
      istio: ingressgateway-customer-admin
    issuers: []
  ingressgateway-customer-user:
    namespace: istio-system
    labelSelector:
      istio: ingressgateway-customer-user
    issuers: []

opa:
  replicas: 3
  port: 9191
  containerPort: 9191
  loglevel: info
  query: data.istio.authz.allow  # this should never really change
  tls:
    enabled: false  # TODO once we have cert manager
    secret: ""
  strategy:
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 25%
    type: RollingUpdate
  resources:
    requests:
      memory: "128Mi"
      cpu: "250m"
    limits:
      memory: "10Gi"
      cpu: "4"
  # Timeout defaults to 200ms if not specified. Setting it to 20s, an
  # arbitrary long timeout, provides sufficient overhead to resolve
  # CASMPET-1804/2570 "deadline exceeded" gRPC errors for the ext_authz filter.
  # A newer version of OPA might fix this with better performance.
  timeout: 25s
  # http.send requests default to 5s timeout. This was failing on a system so
  # increase this to 10s.
  httpTimeout: 10s
  requireHeartbeatToken: false
  xnamePolicy:
    enabled: false
    bos: false
    cfs: false
    ckdump: false
    dvs: false
    heartbeat: false

# To overide the default policy in files/policy.rego follow the example below
# NOTE: If the policy changes or is overriden, you MUST do a rolling restart of the
# OPA pods to pick them up until we stop mounting as a configmap.

# policy: |
#   # Istio Ingress Gateway OPA Policy
#   package istio.authz

#   default allow = true

# Run each opa pod on a separate worker when possible
affinity:
  default: true

jwtValidation:
  keycloak:
    jwksUri: "https://istio-ingressgateway.istio-system.svc.cluster.local./keycloak/realms/shasta/protocol/openid-connect/certs"
  spire:
    jwksUri: "https://istio-ingressgateway.istio-system.svc.cluster.local./spire-jwks-vshastaio/keys"
    issuers:
      vshasta.io: "http://spire.local/shasta/vshastaio"
    trustDomain: shasta
