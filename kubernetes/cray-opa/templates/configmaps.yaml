{{- /*
Copyright 2020 Hewlett Packard Enterprise Development LP
*/ -}}
{{- range $name, $options:= .Values.ingresses }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-config-{{ $name }}
  namespace: {{ $.Release.Namespace }}
data:
  config.yaml: |
    plugins:
      envoy_ext_authz_grpc:
        addr: :{{ $.Values.opa.port }}
        query: {{ $.Values.opa.query }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opa-policy-{{ $name }}
  namespace: {{ $.Release.Namespace }}
data:
  policy.rego: |-
    {{- if $options.policy }}
    {{- $options.policy | nindent 4 }}
    {{- else }}
    {{ $policy := printf "%s.policy" $name }}
    {{- include $policy $ | nindent 4 }}
    {{- end }}
{{- end }}
